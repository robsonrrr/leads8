

<div id="cartContent" class="container-fluid">

    <div class="row g-3">
        <div class="col-12 col-md-3">
            <div class="d-flex align-items-center">
                <i class="bi bi-cart fs-4 me-2"></i>
                <h4 class="h4 h2-md color-primary mb-0">
                    {{Total.variedade}} Produto(s) no Carrinho
                </h4>
            </div>
        </div>
        <div class="col-12 col-md-2">
            <div class="custom-control custom-switch d-flex align-items-center">
                <input type="checkbox" class="custom-control-input me-2" id="customSwitch1" data-update="{{CONTAINER}}lead/session/{{id}}" {{#SESSION.check}}checked{{/SESSION.check}}>
                <label class="custom-control-label mb-0" for="customSwitch1">Verificar Estoque</label>
            </div>
        </div>

        <div class="col-12 col-md-7">
            <div class="d-flex flex-wrap justify-content-center justify-content-md-end gap-2">
                <!-- Toggle Peso Column Button -->
                <button id="togglePesoColumn" type="button" class="btn btn-outline-secondary btn-sm" title="Mostrar/Ocultar Coluna Peso">
                    <i class="bi bi-eye-slash" id="pesoIcon"></i> Peso
                </button>
                
                 <div class="btn-group" role="group" aria-label="Button group with nested dropdown">
                        <div class="btn-group btn-sm mt-1 p-2" role="group">
                            <button id="btnGroupDrop4" type="button" class="btn btn-outline-primary btn-sm rounded-0 dropdown-toggle p-2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Configurações
                            </button>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="btnGroupDrop4">

                                <a class="dropdown-item" href="#" class="dropdown-item mb-1 border-bottom" data-toggle="modal"
                                       data-target="#modalTicketAdd" data-remote="{{CONTAINER}}ticket/new/{{Cliente.clienteID}}/{{Lead.id}}"
                                       data-name="{{Cliente.clienteNome}}" data-customer="{{Cliente.clienteID}}" data-title="Criar um Novo Ticket" >
                                   criar ticket
                                </a>
                                 <a class="dropdown-item" target="_blank" href="/agendor/tickets/?cliente={{Cliente.clienteID}}&dia=Todos&mes=Todos&ano=Todos">
                                    tickets
                                </a>
                                <a class="dropdown-item" target="_blank" href="/clientes_editar.php?DADOS={{Cliente.id}}">
                                   editar cliente
                                </a>
                               <a class="dropdown-item" target="_blank" href="/orders/orders_per_client.php?client={{Cliente.id}}">
                                   pedidos
                                </a>
                                <a class="dropdown-item" target="_blank" href="{{CONTAINER}}lead/delete/{{id}}/{{segmentoPOID}}">
                                  deletar lead
                                </a>
                                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#modalGerencia" data-lead="{{id}}" data-segment="{{segmentoPOID}}">
                                  enviar para gerência
                                </a>
                                {{#existProducts}}
                                <a class="dropdown-item disabled" onclick="return false;" href="#">
                                    raio-Y
                                </a>
                                {{/existProducts}}
                                {{^existProducts}}
                                <a class="dropdown-item click-ajax-response" href="#" data-url="{{CONTAINER}}lead/raioy/{{id}}/{{segmentoPOID}}">
                                    raio-Y
                                </a>
                                {{/existProducts}}
                                 <a class="dropdown-item click-ajax-response" href="#" data-url="{{CONTAINER}}lead/recalculate/{{id}}/{{segmentoPOID}}?price=true">
                                    atualizar preço
                                </a>
                                 <a target="_blank" class="dropdown-item" href="{{CONTAINER}}lead/mail/{{id}}/{{segmentoPOID}}">
                                    email
                                </a>

                                <a target="_blank" class="dropdown-item" href="{{CONTAINER}}lead/offer/{{id}}/{{segmentoPOID}}">
                                    ofertar
                                </a>
                               {{#SESSION.acessoBoaKostura}}
                                <a class="dropdown-item" target="_blank" href="/leads/leads4/lead/mail/{{id}}/{{segmentoPOID}}?layout=boakostura">
                                    email p/ Boa Kostura
                                </a>
                                {{/SESSION.acessoBoaKostura}}
                                <a target="_blank" class="dropdown-item" href="{{CONTAINER}}lead/print/{{id}}/{{segmentoPOID}}">
                                    imprimir
                                </a>
                                <a class="dropdown-item" target="_blank" href="{{CONTAINER}}lead/clean/{{id}}/{{segmentoPOID}}">
                                    gravar produtos negativos
                                </a>


                                 <a class="dropdown-item"  class="btn btn-info" data-toggle="modal" data-target="#exampleModal" data-lead="{{id}}"
                                    {{#existPendencies}}disabled{{/existPendencies}} {{#existProducts}}disabled{{/existProducts}} >
                               importar</a>

                            </div>
                        </div>
                    </div>
            </div>
        </div>

        {{#existPendencies}}
        <div class="col-12">
            <div class="alert alert-danger" role="alert">
                <strong>Pendências!</strong> favor corrigir {{existPendencies}}
            </div>
        </div>
        {{/existPendencies}}

    </div>

    <!-- 3-Stage Discount Visibility Button -->
    <div class="row mb-3">
        <div class="col-12 text-center">
            <button type="button" class="btn btn-outline-danger btn-sm hide-all-empty-discounts" title="Stage 1: Hide rows with discount = 0">
                <i class="bi bi-eye-slash"></i> Hide Empty (>0)
            </button>
        </div>
    </div>

    <!-- Mobile Card View (visible only on small screens) -->
    <div class="d-block d-lg-none">
        {{#Produtos}}
            <div class="card mb-3 shadow-sm {{#produtoIndisponivel}}border-danger{{/produtoIndisponivel}}" id="card_{{POID}}">
            <div class="card-body p-3">
                <div class="row g-3">
                    <div class="col-4 col-sm-3">
                        <div class="d-flex flex-column align-items-center gap-2">
                            <div class="form-check">
                                <input class="checkBoxClass form-check-input" name="product" type="checkbox" id="product_mobile_{{POID}}" value="{{POID}}">
                                <label class="form-check-label small text-muted" for="product_mobile_{{POID}}">#{{produtoContagem}}</label>
                            </div>
                            <a href="#" class="position-relative" data-toggle="modal" data-title="Produto Informações" data-target="#remoteModal"
                               data-remote="{{CONTAINER}}lead/product/{{produtoPOID}}/{{segmentoPOID}}/{{Lead.clientePOID}}">
                                <img src="{{ENV.img}}id/w96/{{produtoPOID}}.jpg?version={{VERSION}}" class="img-fluid rounded shadow-sm">
                            </a>
                        </div>
                    </div>
                    <div class="col-8 col-sm-9">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">
                                <strong>{{Detalhe.produtoModelo}}</strong>
                            </h6>
                            <a href="#" class="btn btn-sm btn-outline-info" 
                               onclick="new WinBox('Produto Info', { url: 'https://dev.office.internut.com.br/K3/tip/vproduct/{{produtoPOID}}/', width: '90%', height: '90%', x: 'center', y: 'center' }); return false;"
                               title="Ver informações do produto">
                                <i class="bi bi-info-circle"></i>
                            </a>
                        </div>
                        <p class="card-text small mb-3">{{Detalhe.produtoNome}} <span class="text-muted">{{Detalhe.produtoDescricaoCurta}}</span></p>
                        
                        <div class="d-flex flex-wrap gap-3 small mb-3">
                            <div class="d-flex align-items-center">
                                <span class="me-2"><strong>Marca:</strong></span>
                                {{#Detalhe.produtoMarcaFormatado}}
                                <img width="30" src="{{ENV.cdn}}svg/marca/{{Detalhe.produtoMarcaFormatado}}.svg?version={{VERSION}}" title="{{Detalhe.produtoMarca}}" alt="{{Detalhe.produtoMarca}}" class="img-fluid"/>
                                {{/Detalhe.produtoMarcaFormatado}}
                                {{^Detalhe.produtoMarcaFormatado}}
                                <span>s/m</span>
                                {{/Detalhe.produtoMarcaFormatado}}
                            </div>
                            <div class="peso-mobile" style="display: none;">
                                <strong>Peso:</strong> <span>{{Detalhe.produtoPeso}}</span>
                                {{#SESSION.acessoFinanceiro}}
                                <br><small class="text-danger">Frete: {{produtoFrete}}/{{produtoFreteTotal}}</small>
                                {{/SESSION.acessoFinanceiro}}
                            </div>
                        </div>
                        
                        {{^produtoIndisponivel}}
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="row g-2">
                                    <div class="col-6 col-sm-4">
                                        <label class="small d-block mb-1"><strong>Quantidade:</strong></label>
                                        <input type="text" class="form-control form-control-sm qty-cart text-center mask-qty" 
                                               data-update="/services/cart/update/{{POID}}" data-lead="{{id}}"
                                               data-product="{{produtoPOID}}" data-times="{{produtoVezes}}" 
                                               id="qty_cart_mobile_{{produtoPOID}}" value="{{produtoQuantidade}}" 
                                               name="produtoQuantidade" min="1" max="999999" maxlength="5">
                                        {{#SESSION.check}}
                                        <small class="text-muted d-block mt-1">Est: {{stock.estoqueEcommerce}}/{{stock.estoqueComercial}}</small>
                                        {{/SESSION.check}}
                                    </div>
                                    <div class="col-6 col-sm-4">
                                        <label class="small d-block mb-1"><strong>Vezes:</strong></label>
                                        <div class="bg-light rounded px-3 py-2 h-100 d-flex align-items-center justify-content-center">{{produtoVezes}}</div>
                                    </div>
                                    <div class="col-6 col-sm-4">
                                        <label class="small d-block mb-1"><strong>Index:</strong></label>
                                        <div class="bg-light rounded px-3 py-2 h-100 d-flex align-items-center justify-content-center">{{produtoIndex}}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <label class="small d-block mb-1"><strong>Valor de Venda:</strong></label>
                                <div class="d-flex flex-column gap-1">
                                    <div>
                                        {{#produtoPrecoAjustado}}
                                        <input type="text" class="form-control form-control-sm text-center product-discount color-primary font-weight-bolder w-100"
                                               id="qty_cart_discount_mobile_{{produtoPOID}}" data-type="price" 
                                               data-product="{{produtoPOID}}" data-lead-product="{{POID}}" data-lead="{{id}}" 
                                               data-url="{{CONTAINER}}lead/discount" data-segment="{{segmentoPOID}}" 
                                               value="{{produtoValorFormatado}}" style="min-width: 150px;">
                                        {{/produtoPrecoAjustado}}
                                        {{^produtoPrecoAjustado}}
                                        <input type="text" class="form-control form-control-sm text-center product-discount text-dark font-weight-bolder w-100"
                                               id="qty_cart_discount_mobile_{{produtoPOID}}" data-type="price" 
                                               data-product="{{produtoPOID}}" data-lead-product="{{POID}}" data-lead="{{id}}" 
                                               data-url="{{CONTAINER}}lead/discount" data-segment="{{segmentoPOID}}" 
                                               value="{{produtoValorFormatado}}" style="min-width: 150px;">
                                        {{/produtoPrecoAjustado}}
                                    </div>
                                    <div class="d-flex flex-wrap align-items-center gap-2 small">
                                        <span class="text-muted">Original: R$ {{produtoValorOriginal}}</span>
                                        {{#SESSION.acessoDiretoria}}
                                        <span class="text-info product-fob-display" data-fob="{{Detalhe.produtoFob}}">FOB: US$ {{Detalhe.produtoFob}}</span>
                                        {{/SESSION.acessoDiretoria}}
                                    </div>
                                </div>
                                
                                <!-- Botões Multiplicadores Mobile -->
                                {{#SESSION.acessoDiretoria}}
                                <div class="mt-2">
                                    <label class="small d-block mb-1 text-muted">Multiplicadores:</label>
                                    <div class="btn-group w-100 flex-wrap" role="group">
                                        <button class="btn btn-outline-secondary btn-sm update-discount-btn" type="button" 
                                                data-target="qty_cart_discount_mobile_{{produtoPOID}}" 
                                                data-base-price="{{Detalhe.produtoFob}}"
                                                data-multiplier="9.05"
                                                title="Atualizar com preço base × 9.05">×9.05</button>
                                        <button class="btn btn-outline-secondary btn-sm update-discount-btn" type="button" 
                                                data-target="qty_cart_discount_mobile_{{produtoPOID}}" 
                                                data-base-price="{{Detalhe.produtoFob}}"
                                                data-multiplier="9.50"
                                                title="Atualizar com preço base × 9.50">×9.50</button>
                                        <button class="btn btn-outline-info btn-sm update-discount-btn" type="button" 
                                                data-target="qty_cart_discount_mobile_{{produtoPOID}}" 
                                                data-base-price="{{Detalhe.produtoFob}}"
                                                data-multiplier="10"
                                                title="Atualizar com preço base × 10">×10</button>
                                        <button class="btn btn-outline-secondary btn-sm update-discount-btn" type="button" 
                                                data-target="qty_cart_discount_mobile_{{produtoPOID}}" 
                                                data-base-price="{{Detalhe.produtoFob}}"
                                                data-multiplier="10.50"
                                                title="Atualizar com preço base × 10.50">×10.50</button>
                                        <button class="btn btn-outline-secondary btn-sm update-discount-btn" type="button" 
                                                data-target="qty_cart_discount_mobile_{{produtoPOID}}" 
                                                data-base-price="{{Detalhe.produtoFob}}"
                                                data-multiplier="11"
                                                title="Atualizar com preço base × 11">×11</button>
                                        <button class="btn btn-outline-secondary btn-sm update-discount-btn" type="button" 
                                                data-target="qty_cart_discount_mobile_{{produtoPOID}}" 
                                                data-base-price="{{Detalhe.produtoFob}}"
                                                data-multiplier="12"
                                                title="Atualizar com preço base × 12">×12</button>
                                    </div>
                                </div>
                                {{/SESSION.acessoDiretoria}}
                            </div>
                            
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center bg-light rounded p-2">
                                    <div>
                                        <strong class="text-success">Subtotal: R$ {{produtoValorSubtotal}}</strong>
                                        {{#SESSION.acessoWebmaster}}
                                        <small class="d-block text-muted">(R$ {{produtoValor}} unit.)</small>
                                        {{/SESSION.acessoWebmaster}}
                                    </div>
                                    <a class="cart-remove-item btn btn-sm btn-outline-danger" href="#card_{{POID}}" 
                                       data-lead-id="{{leadPOID}}" id="card_remove_{{POID}}" 
                                       data-name="{{Detalhe.produtoModelo}}" data-product-id="{{POID}}" 
                                       data-service="/services/cart/delete/{{POID}}/{{segmentoPOID}}">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {{/produtoIndisponivel}}
                        
                        {{#produtoIndisponivel}}
                        <div class="alert alert-danger mt-2 mb-0">
                            <small>Quantidade do item indisponível</small>
                        </div>
                        {{/produtoIndisponivel}}
                    </div>
                </div>
            </div>
        </div>
        {{/Produtos}}
        
        {{^Produtos}}
        <div class="text-center py-5">
            <img src="{{ENV.cdn}}media/r6/carrinho-vazio.svg" width="150" class="mb-3" />
            <h4 class="text-muted">Seu Carrinho está vazio!</h4>
        </div>
        {{/Produtos}}
    </div>

    <!-- Desktop Table View (hidden on small screens) -->
    <div class="d-none d-lg-block">
    <table class="table table-sm table-bordered table-hover table-striped contentSearchHighlight" id="cartTable">
        <thead class="thead-custom">
            <tr>
                <th class="align-middle text-center" scope="col">#</th>
                <th class="align-middle sorter-false filter-false" scope="col">IMG</th>
                <th class="align-middle" scope="col">Produto</th>
                <th class="align-middle text-center" scope="col">Marca</th>
                <th class="align-middle text-center peso-column" scope="col" style="display: none;">Peso</th>
                <th class="align-middle text-center" scope="col">Qtd.</th>
                <th class="align-middle text-center" scope="col">Vezes</th>
                <th class="align-middle text-center" scope="col">Valor de Venda</th>
                <th class="align-middle text-center" scope="col">Index</th>
                <th class="align-middle text-right" scope="col">Subtotal Produto</th>
                {{#clienteDoClientePOID}}
                <th class="align-middle text-right" scope="col">Valor do Cliente</th>
                {{/clienteDoClientePOID}}
                <th class="align-middle text-center sorter-false filter-false" scope="col">#</th>
            </tr>
        </thead>
        <tbody>
            {{#Produtos}}
            <tr id="colunm_{{POID}}" class="{{#produtoIndisponivel}}table-danger{{/produtoIndisponivel}}">
                <th class="align-middle text-center" width="1%" scope="row">
                    <p class="p-0 m-0">
                        {{produtoContagem}}
                    </p>
                    <p class="p-0 m-0">
                        <input class="checkBoxClass" name="product" type="checkbox" id="product_{{POID}}" value="{{POID}}">
                    </p>
                </th>
                <td class="align-middle text-center" width="1%">
                    <a href="#" class="" data-toggle="modal" data-title="Produto Informações" data-target="#remoteModal"
                       data-remote="{{CONTAINER}}lead/product/{{produtoPOID}}/{{segmentoPOID}}/{{Lead.clientePOID}}">
                        <img src="{{ENV.img}}id/w96/{{produtoPOID}}.jpg?version={{VERSION}}">
                    </a>
                </td>
                <td class="align-middle font12" width="40%">
                    <div class="p-0 m-0">
                        <strong>{{Detalhe.produtoModelo}}</strong>
                        <a href="#" class="btn btn-sm btn-outline-info ms-2" 
                           onclick="new WinBox('Produto Info', { url: 'https://dev.office.internut.com.br/K3/tip/vproduct/{{produtoPOID}}/', width: 1800, height: 1200, x: 'center', y: 'center' }); return false;"
                           title="Ver informações do produto">
                            <i class="bi bi-info-circle"></i>
                        </a>
                        {{> partials/product-actions}}
                                     
                    </div>
                    <div class="p-0 m-0">
                        {{Detalhe.produtoNome}} <span class="p-0 m-0 font10 text-muted"> {{Detalhe.produtoDescricaoCurta}} </span>
                    </div>
                </td>
                <td class="align-middle text-center" width="5%">
                    {{#Detalhe.produtoMarcaFormatado}}
                    <img width="50" src="{{ENV.cdn}}svg/marca/{{Detalhe.produtoMarcaFormatado}}.svg?version={{VERSION}}" title="{{Detalhe.produtoMarca}}" alt="{{Detalhe.produtoMarca}}"/>
                    {{/Detalhe.produtoMarcaFormatado}}
                    {{^Detalhe.produtoMarcaFormatado}}
                    s/m
                    {{/Detalhe.produtoMarcaFormatado}}
                </td>
                <td class="align-middle text-center peso-column" style="display: none;">
                    <span>{{Detalhe.produtoPeso}}</span>
                    {{#SESSION.acessoFinanceiro}}
                    <p class="p-0 pt-2 m-0 font11 text-danger">Frete: {{produtoFrete}} / {{produtoFreteTotal}}</p>
                    {{/SESSION.acessoFinanceiro}}
                </td>
                <td class="align-middle text-center" width="10%">
                    <input type="text" class="form-control form-control-sm rounded-0 qty-cart text-center mask-qty" data-update="/services/cart/update/{{POID}}" data-lead="{{id}}" autocomplete="off"
                           data-product="{{produtoPOID}}" data-times="{{produtoVezes}}" id="qty_cart_{{produtoPOID}}" value="{{produtoQuantidade}}" name="produtoQuantidade"
                           min="1" max="999999" maxlength="5">
                    {{#SESSION.check}}
                    <a href="#" class="" data-toggle="modal" data-title="Estoque Ecommerce" data-target="#remoteModal"
                       data-remote="{{CONTAINER}}product/ecommerce/{{produtoPOID}}/{{Lead.unidadeEmitentePOID}}"  title="Esoque Ecommerce: Carrinho Ativos">
                        <small class="text-muted">{{stock.estoqueEcommerce}}</small>
                    </a>
                    / <small class="text-muted" title="Estoque Comercial">{{stock.estoqueComercial}}</small>
                    {{#SESSION.acessoGerencial}}
                    / <small class="text-danger" title="Estoque Geral">{{stock.estoqueGeral}}</small>
                    {{/SESSION.acessoGerencial}}
                    {{/SESSION.check}}
                    {{^SESSION.check}}
                    <small class="text-warning">-</small>
                    {{/SESSION.check}}
                </td>
                {{#produtoIndisponivel}}
                <td class="align-middle text-center">-</td>
                <td class="align-middle text-center">-</td>
                <td class="align-middle text-center">-</td>
                <td class="align-middle text-center">Quantidade do item indisponível</td>
                {{#clienteDoClientePOID}}
                <td class="align-middle text-center">-</td>
                {{/clienteDoClientePOID}}
                {{/produtoIndisponivel}}
                {{^produtoIndisponivel}}
                <td class="align-middle text-center">{{produtoVezes}}</td>
                <td class="align-middle text-center" width="10%">
                    <div class="input-group input-group-sm">
                        {{#produtoPrecoAjustado}}
                        <input type="text" class="form-control rounded-0 text-center product-discount color-primary font-weight-bolder"
                               id="qty_cart_discount_{{produtoPOID}}" data-type="price" min="0" max="" maxlength="" data-product="{{produtoPOID}}"
                               data-lead-product="{{POID}}" data-lead="{{id}}" data-url="{{CONTAINER}}lead/discount"
                               data-segment="{{segmentoPOID}}" value="{{produtoValorFormatado}}">
                        {{/produtoPrecoAjustado}}
                        {{^produtoPrecoAjustado}}
                        <input type="text" class="form-control rounded-0 text-center product-discount text-dark font-weight-bolder"
                               id="qty_cart_discount_{{produtoPOID}}" data-type="price" min="0" max="" maxlength="" data-product="{{produtoPOID}}"
                               data-lead-product="{{POID}}" data-lead="{{id}}" data-url="{{CONTAINER}}lead/discount"
                               data-segment="{{segmentoPOID}}" value="{{produtoValorFormatado}}">
                        {{/produtoPrecoAjustado}}
                        {{#SESSION.acessoDiretoria}}
                        <div class="input-group-append">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-secondary btn-sm update-discount-btn" type="button" 
                                        data-target="qty_cart_discount_{{produtoPOID}}" 
                                        data-base-price="{{Detalhe.produtoFob}}"
                                        data-multiplier="9.05"
                                        title="Atualizar com preço base × 9.05">×9.05</button>
                                <button class="btn btn-outline-secondary btn-sm update-discount-btn" type="button" 
                                        data-target="qty_cart_discount_{{produtoPOID}}" 
                                        data-base-price="{{Detalhe.produtoFob}}"
                                        data-multiplier="9.50"
                                        title="Atualizar com preço base × 9.50">×9.50</button>
                                <button class="btn btn-outline-info btn-sm update-discount-btn" type="button" 
                                        data-target="qty_cart_discount_{{produtoPOID}}" 
                                        data-base-price="{{Detalhe.produtoFob}}"
                                        data-multiplier="10"
                                        title="Atualizar com preço base × 10">×10</button>
                                <button class="btn btn-outline-secondary btn-sm update-discount-btn" type="button" 
                                        data-target="qty_cart_discount_{{produtoPOID}}" 
                                        data-base-price="{{Detalhe.produtoFob}}"
                                        data-multiplier="10.50"
                                        title="Atualizar com preço base × 10.50">×10.50</button>
                                <button class="btn btn-outline-secondary btn-sm update-discount-btn" type="button" 
                                        data-target="qty_cart_discount_{{produtoPOID}}" 
                                        data-base-price="{{Detalhe.produtoFob}}"
                                        data-multiplier="11"
                                        title="Atualizar com preço base × 11">×11</button>
                                <button class="btn btn-outline-secondary btn-sm update-discount-btn" type="button" 
                                        data-target="qty_cart_discount_{{produtoPOID}}" 
                                        data-base-price="{{Detalhe.produtoFob}}"
                                        data-multiplier="12"
                                        title="Atualizar com preço base × 12">×12</button>
                            </div>
                        </div>
                        {{/SESSION.acessoDiretoria}}
                    </div>

                    <small title="Preço Cliente">R$ {{produtoValorOriginal}}</small>
                    {{#SESSION.acessoGerencial}}
                    / <small title="Preço base do Produto" class="text-danger"> R$ {{Detalhe.produtoRevenda}}</small>
                    {{/SESSION.acessoGerencial}}
                    {{#SESSION.acessoDiretoria}}
                    /<small title="Preço base do Produto" class="text-info product-fob-display" data-fob="{{Detalhe.produtoFob}}">US$ {{Detalhe.produtoFob}}</small>
                    {{/SESSION.acessoDiretoria}}
                </td>
                <td class="align-middle text-center">
                    <small>{{produtoIndex}}</small>
                </td>

                <td class="align-middle text-right" width="10%">
                    <p class="p-0 m-0">R$ {{produtoValorSubtotal}}</p>
                    {{#SESSION.acessoWebmaster}}
                    <p class="p-0 m-0 font11 text-muted">(R$ {{produtoValor}} unit.)</p>
                    {{/SESSION.acessoWebmaster}}
                </td>
                 {{#clienteDoClientePOID}}
                <td class="align-middle text-center" width="10%">
                   
                    <input type="text" class="form-control form-control-sm rounded-0 text-center product-discount text-dark font-weight-bolder"
                           id="qty_cart_customer_{{produtoPOID}}" data-type="pricecc" min="0" max="" maxlength="" data-product="{{produtoPOID}}"
                           data-lead-product="{{POID}}" data-lead="{{id}}" data-url="{{CONTAINER}}lead/discount"
                           data-segment="{{segmentoPOID}}" value="{{produtoCCValorFormatado}}">
                    <!--<small title="Preço Cliente">Comissão {{produtoValorOriginal}}</small>//-->
                   

                </td>
                 {{/clienteDoClientePOID}}
                {{/produtoIndisponivel}}
                <td class="align-middle text-center" width="1%">
                    <a class="cart-remove-item btn btn-sm btn-danger" href="#colunm_{{POID}}" data-lead-id="{{leadPOID}}" id="colunm_remove_{{POID}}" data-name="{{Detalhe.produtoModelo}}" data-product-id="{{POID}}" data-service="/services/cart/delete/{{POID}}/{{segmentoPOID}}">
                        <i class="bi bi-trash" aria-hidden="true"></i>
                    </a>
                </td>
            </tr>
            {{/Produtos}}
            {{^Produtos}}
            <tr>
                <td class="text-center p-3">&nbsp;</td>
                <td class="text-center p-3">&nbsp;</td>
                <td class="text-center p-3">&nbsp;</td>
                <td class="text-center p-3">&nbsp;</td>
                <td class="text-center p-3">&nbsp;</td>
                <td class="text-center p-3">
                    <p>
                        <img src="{{ENV.cdn}}media/r6/carrinho-vazio.svg" width="200" />
                    </p>
                    <span class="h4 text-muted">Seu Carrinho está vazio!</span>
                </td>
                <td class="text-center p-3">&nbsp;</td>
                <td class="text-center p-3">&nbsp;</td>
                <td class="text-center p-3">&nbsp;</td>
                <td class="text-center p-3">&nbsp;</td>
                {{#clienteDoClientePOID}}
                <td class="text-center p-3">&nbsp;</td>
                {{/clienteDoClientePOID}}
                <td class="text-center p-3">&nbsp;</td>
            </tr>
            {{/Produtos}}
        </tbody>
        {{#Total}}
        <tfoot class="{{^Produtos}}d-none {{/Produtos}}bg-custom">
            <tr height="30">
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                {{#clienteDoClientePOID}}
                <td></td>
                {{/clienteDoClientePOID}}
                <td></td>
            </tr>
            <tr class="font-weight-bold lead">
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="align-middle text-center peso-column" style="display: none;">{{peso}}</td>
                <td class="align-middle text-center">{{quantidade}}</td>
                <td class="align-middle text-center"></td>               
                                <td></td>
                <td class="align-middle text-center"><strong>{{indexAvg}}</strong></td>
                <td class="align-middle text-right">{{produto}}</td>
                {{#clienteDoClientePOID}}
                <td class="align-middle text-right">{{produtocc}}</td>
                {{/clienteDoClientePOID}}
                 <td class="align-middle text-right"></td>                
                <td></td>
            </tr>
            <tr class="font11">
                <th class="align-middle text-center" scope="col">#</th>
                <th class="align-middle sorter-false filter-false" scope="col">IMG</th>
                <th class="align-middle" scope="col">Produto</th>
                <th class="align-middle" scope="col">Marca</th>
                <th class="align-middle text-center peso-column" scope="col" style="display: none;">Peso</th>
                <th class="align-middle text-center" scope="col">Qtd.</th>
                <th class="align-middle text-center" scope="col">Vezes</th>
                <th class="align-middle text-center" scope="col">Valor Venda</th>
                <th class="align-middle text-center" scope="col">Index</th>
                <th class="align-middle text-right" scope="col">Subtotal Produto</th>
                {{#clienteDoClientePOID}}
                <th class="align-middle text-right" scope="col">Valor do Cliente</th>
                {{/clienteDoClientePOID}}
                <th class="align-middle text-center sorter-false filter-false" scope="col">#</th>
            </tr>
        </tfoot>
        {{/Total}}
    </table>
    </div>

</div>

{{#ClienteDoCliente}}
<p class="h2 color-primary">
    <i class="bi bi-cash-stack"></i> Comissão Revendedor
</p>
<table class="table table-sm table-bordered table-hover table-striped">
    <thead class="thead-custom">
        <tr>
            <th>Total Pedido</th>
            <th>Custo Mercadoria</th>
            <th>Desconto Cartão</th>
            <th>Desconto PIS/CONFINS</th>
            <th>Desconto ICMS</th>
            <th>Comissão a Pagar</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td class="">R$ {{Total.produtocc}}</td>
            <td class="text-danger">R$ - {{Total.produto}}</td>
            <td class="text-danger">R$ - {{descontoFP}}</td>
            <td class="text-danger">R$ - {{descontoFederal}}</td>
            <td class="text-danger">R$ - {{descontoICMS}}</td>
            <td class="bold lead text-success">R$ {{Total.comissao}} <small>( {{percentual}} %)</small></td>
        </tr>
    </tbody>
</table>
{{/ClienteDoCliente}}


<div class="container-fluid">
    <div class="row g-3">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row gap-2">
                <div class="btn-group flex-wrap" role="group">
                    <button id="" name="remove" class="btn btn-outline-secondary btn-sm submitProducts">
                        <i class="bi bi-x-circle me-1"></i>Remover Selecionados
                    </button>
                    <button id="" name="add" class="btn btn-outline-secondary btn-sm submitProducts">
                        <i class="bi bi-check-circle me-1"></i>Manter Selecionados
                    </button>
                    <button id="" name="notify" class="btn btn-outline-secondary btn-sm submitProducts">
                        <i class="bi bi-bell me-1"></i>Avise-me
                    </button>
                    <button id="" name="lost" class="btn btn-outline-secondary btn-sm submitProducts">
                        <i class="bi bi-archive me-1"></i>Salvar como Perdidos
                    </button>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm cart-remove" href="#cart_remove" 
                        {{^existProducts}}disabled{{/existProducts}} data-lead-id="{{id}}" id="cart_remove" 
                        data-service="/services/cart/clear/{{id}}">
                    <i class="bi bi-trash me-1"></i>Remover Todos
                </button>
            </div>
        </div>

        {{#existProducts}}
        <div class="col-12">
            <div class="d-flex flex-column align-items-center">
                <a href="{{CONTAINER}}order/checkout/{{id}}/{{segmentoPOID}}"
                   class="btn btn-primary btn-lg w-100 w-lg-auto mb-2 {{^SESSION.check}}disabled{{/SESSION.check}} {{#existPendencies}}disabled{{/existPendencies}} {{#multiple}}disabled{{/multiple}}">
                    <i class="bi bi-fast-forward me-2"></i>Próxima Etapa
                </a>
                <small class="text-muted">+1 etapa para concluir o pedido</small>
            </div>
        </div>
        {{/existProducts}}
    </div>
</div>

<style>
/* Base styles */
:root {
    --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
    --card-radius: 12px;
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --font-size-sm: 0.875rem;
    --font-size-xs: 0.75rem;
}

/* Card styles */
.card {
    border: 1px solid rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--card-shadow);
}

/* Form controls */
.form-control-sm {
    font-size: var(--font-size-sm);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: 4px;
}

.form-check-input {
    cursor: pointer;
}

/* Buttons and actions */
.btn-group {
    gap: var(--spacing-xs);
}

.btn-sm {
    font-size: var(--font-size-sm);
    padding: var(--spacing-xs) var(--spacing-sm);
}

.btn-outline-secondary:hover,
.btn-outline-danger:hover {
    transform: translateY(-1px);
}

/* Mobile-specific improvements */
@media (max-width: 991.98px) {
    .h2-md {
        font-size: 1.5rem;
    }
    
    .card {
        box-shadow: var(--card-shadow);
        border-radius: var(--card-radius);
    }
    
    .card-body {
        padding: var(--spacing-md);
    }
    
    .btn-group {
        width: 100%;
    }
    
    .btn-group .btn {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .dropdown-menu {
        width: 100%;
        margin-top: var(--spacing-xs);
        border-radius: var(--card-radius);
        box-shadow: var(--card-shadow);
    }
    
    .dropdown-item {
        padding: var(--spacing-sm) var(--spacing-md);
    }
    
    .form-control-sm {
        min-height: 38px;
    }
    
    .alert {
        padding: var(--spacing-sm);
        border-radius: var(--card-radius);
    }
}

/* Small mobile devices */
@media (max-width: 575.98px) {
    :root {
        --spacing-md: 0.75rem;
    }
    
    .container-fluid {
        padding-left: var(--spacing-md);
        padding-right: var(--spacing-md);
    }
    
    .btn-sm {
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--font-size-xs);
    }
    
    .h4 {
        font-size: 1.25rem;
    }
    
    .card-body {
        padding: var(--spacing-sm);
    }
}

/* Tablet and desktop improvements */
@media (min-width: 992px) {
    .table-responsive {
        overflow-x: visible;
    }
    
    .btn-group {
        flex-wrap: nowrap;
    }
    
    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
}

/* Modal and overlay improvements */
.modal-content {
    border-radius: var(--card-radius);
    box-shadow: var(--card-shadow);
}

.winbox {
    border-radius: var(--card-radius);
}

@media (max-width: 768px) {
    .winbox {
        width: 95% !important;
        height: 90% !important;
        left: 2.5% !important;
        top: 5% !important;
        border-radius: var(--card-radius) !important;
    }
}

/* Animations and transitions */
.btn, .card, .form-control {
    transition: all 0.2s ease-in-out;
}

/* Accessibility improvements */
@media (prefers-reduced-motion: reduce) {
    * {
        transition: none !important;
    }
}
</style>

<script>
// Wait for jQuery and DataTables to be available
(function() {
    function initDataTable() {
        if (typeof $ !== 'undefined' && $.fn.DataTable) {
            // Check if table exists and is not already initialized
            const $table = $('#cartTable');
            if ($table.length === 0) {
                return; // Table doesn't exist, skip initialization
            }
            
            // Destroy existing DataTable if it exists - with better error handling
            if ($.fn.DataTable.isDataTable('#cartTable')) {
                try {
                    const dtInstance = $table.DataTable();
                    // Check if instance is valid before destroying
                    if (dtInstance && typeof dtInstance.destroy === 'function') {
                        // Clear any pending operations
                        if (typeof dtInstance.clear === 'function') {
                            try {
                                dtInstance.clear();
                            } catch (clearError) {
                                // Ignore clear errors
                            }
                        }
                        // Destroy with remove option to clean up DOM
                        dtInstance.destroy(true);
                    }
                } catch (e) {
                    console.warn('Error destroying DataTable:', e);
                    // Force cleanup by removing DataTable data
                    try {
                        // Remove all DataTable-related data
                        $table.removeData();
                        $table.off();
                        // Remove DataTable classes
                        $table.removeClass('dataTable');
                        $table.find('*').removeClass('sorting sorting_asc sorting_desc');
                    } catch (cleanupError) {
                        // Ignore cleanup errors
                    }
                }
            }
            
            // Only initialize DataTable on desktop
            if (window.innerWidth >= 992) {
                try {
                    // Ensure table is visible and has proper structure before initializing
                    if ($table.is(':visible')) {
                        // Validate table structure
                        const thead = $table.find('thead');
                        const tbody = $table.find('tbody');
                        const rows = tbody.find('tr');
                        
                        // Only initialize if table has proper structure
                        if (thead.length > 0 && tbody.length > 0 && rows.length > 0) {
                            // Validate that all header cells exist
                            const headerCells = thead.find('th');
                            if (headerCells.length === 0) {
                                console.warn('DataTable: No header cells found, skipping initialization');
                                return;
                            }
                            
                            // Wait a bit to ensure DOM is fully ready and no AJAX requests are pending
                            setTimeout(function() {
                                try {
                                    // Double-check table is still valid and not already initialized
                                    if ($table.length > 0 && 
                                        $table.is(':visible') && 
                                        !$.fn.DataTable.isDataTable('#cartTable')) {
                                        
                                        // Verify table structure is still intact
                                        const currentThead = $table.find('thead');
                                        const currentTbody = $table.find('tbody');
                                        
                                        if (currentThead.length > 0 && currentTbody.length > 0) {
                                            // Initialize with error handling
                                            const dtOptions = {
                                                "paging": true,
                                                "searching": true,
                                                "ordering": true,
                                                "info": true,
                                                "responsive": true,
                                                "deferRender": true,
                                                "processing": false,
                                                "language": {
                                                    "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json",
                                                    "loadingRecords": "Carregando...",
                                                    "processing": "Processando...",
                                                    "emptyTable": "Nenhum registro encontrado",
                                                    "zeroRecords": "Nenhum registro encontrado",
                                                    "lengthMenu": "Mostrar _MENU_ registros",
                                                    "info": "Mostrando _START_ até _END_ de _TOTAL_ registros",
                                                    "infoEmpty": "Mostrando 0 até 0 de 0 registros",
                                                    "infoFiltered": "(filtrado de _MAX_ registros)",
                                                    "search": "Buscar:",
                                                    "paginate": {
                                                        "first": "Primeiro",
                                                        "last": "Último",
                                                        "next": "Próximo",
                                                        "previous": "Anterior"
                                                    }
                                                },
                                                "columnDefs": [
                                                    { "orderable": false, "targets": [0, 1, -1] } // # and IMG columns, and last column (Action)
                                                ],
                                                "pageLength": 25,
                                                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                                                "drawCallback": function(settings) {
                                                    // Called after each table redraw
                                                },
                                                "error": function(xhr, error, thrown) {
                                                    console.warn('DataTable AJAX error (if applicable):', error);
                                                    // Don't break the table if language file fails to load
                                                }
                                            };
                                            
                                            // Wrap in try-catch for extra safety
                                            try {
                                                $table.DataTable(dtOptions);
                                            } catch (dtError) {
                                                console.error('DataTable initialization error:', dtError);
                                                // Try to initialize without language file as fallback
                                                try {
                                                    dtOptions.language = {
                                                        "loadingRecords": "Carregando...",
                                                        "processing": "Processando...",
                                                        "emptyTable": "Nenhum registro encontrado",
                                                        "zeroRecords": "Nenhum registro encontrado"
                                                    };
                                                    delete dtOptions.language.url;
                                                    $table.DataTable(dtOptions);
                                                } catch (fallbackError) {
                                                    console.error('DataTable fallback initialization also failed:', fallbackError);
                                                }
                                            }
                                        }
                                    }
                                } catch (initError) {
                                    console.error('Error preparing DataTable initialization:', initError);
                                }
                            }, 100);
                        } else {
                            console.warn('DataTable: Table structure incomplete, skipping initialization');
                        }
                    }
                } catch (e) {
                    console.error('Error preparing DataTable initialization:', e);
                }
            }
        } else {
            // Retry after a short delay if jQuery/DataTables not ready
            setTimeout(initDataTable, 100);
        }
    }
    
    // Function to safely destroy DataTable before page reload
    function destroyDataTable() {
        if (typeof $ === 'undefined' || !$.fn.DataTable) {
            return;
        }
        
        try {
            const $table = $('#cartTable');
            if ($table.length === 0) {
                return;
            }
            
            if ($.fn.DataTable.isDataTable('#cartTable')) {
                try {
                    const dtInstance = $table.DataTable();
                    // Validate instance before destroying
                    if (dtInstance && typeof dtInstance.destroy === 'function') {
                        // Clear operations first
                        if (typeof dtInstance.clear === 'function') {
                            dtInstance.clear();
                        }
                        // Destroy with remove option
                        dtInstance.destroy(true);
                    }
                } catch (e) {
                    // If destroy fails, try to clean up manually
                    try {
                        $table.removeData();
                        $table.off();
                        $table.find('*').off();
                    } catch (cleanupError) {
                        // Ignore cleanup errors
                    }
                }
            }
        } catch (e) {
            // Silently ignore all errors - page reload will clean up
        }
    }
    
    // Sync mobile and desktop checkboxes
    function syncCheckboxes() {
        $(document).on('change', '.checkBoxClass', function() {
            const value = $(this).val();
            const isChecked = $(this).is(':checked');
            
            // Sync between mobile and desktop versions
            $(`input[value="${value}"].checkBoxClass`).prop('checked', isChecked);
        });
    }
    
    // Handle window resize to reinitialize DataTable if needed
    function handleResize() {
        let resizeTimer;
        let lastWidth = window.innerWidth;
        $(window).on('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                const currentWidth = window.innerWidth;
                // Only reinitialize if crossing the desktop/mobile threshold (992px)
                const wasDesktop = lastWidth >= 992;
                const isDesktop = currentWidth >= 992;
                
                if (wasDesktop !== isDesktop) {
                    // Crossing threshold - reinitialize
                    initDataTable();
                }
                lastWidth = currentWidth;
            }, 250);
        });
    }
    
    // Toggle Peso Column functionality
    function initPesoToggle() {
        const toggleButton = document.getElementById('togglePesoColumn');
        const pesoIcon = document.getElementById('pesoIcon');
        let isPesoVisible = false;
        
        if (toggleButton) {
            toggleButton.addEventListener('click', function() {
                const pesoColumns = document.querySelectorAll('.peso-column');
                const pesoMobile = document.querySelectorAll('.peso-mobile');
                
                isPesoVisible = !isPesoVisible;
                
                // Toggle desktop columns
                pesoColumns.forEach(function(column) {
                    column.style.display = isPesoVisible ? '' : 'none';
                });
                
                // Toggle mobile peso info
                pesoMobile.forEach(function(element) {
                    element.style.display = isPesoVisible ? '' : 'none';
                });
                
                // Update button icon and text
                if (isPesoVisible) {
                    pesoIcon.className = 'bi bi-eye';
                    toggleButton.classList.remove('btn-outline-secondary');
                    toggleButton.classList.add('btn-outline-primary');
                } else {
                    pesoIcon.className = 'bi bi-eye-slash';
                    toggleButton.classList.remove('btn-outline-primary');
                    toggleButton.classList.add('btn-outline-secondary');
                }
            });
        }
    }
    
    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initDataTable();
            syncCheckboxes();
            handleResize();
            initPesoToggle();
        });
    } else {
        initDataTable();
        syncCheckboxes();
        handleResize();
        initPesoToggle();
    }
    
    // Expose destroyDataTable globally for use in other scripts
    window.destroyDataTable = destroyDataTable;
})();
</script>

<!-- Modal para Enviar para Gerencia -->
<div class="modal fade" id="modalGerencia" tabindex="-1" role="dialog" aria-labelledby="modalGerenciaLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalGerenciaLabel">Enviar Mensagem para Gerência</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="formGerencia">
          <input type="hidden" id="leadId" name="leadId" value="">
          <div class="form-group">
            <label for="mensagemGerencia">Mensagem:</label>
            <textarea class="form-control" id="mensagemGerencia" name="mensagem" rows="4" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnEnviarGerencia">Enviar</button>
      </div>
    </div>
  </div>
</div>

