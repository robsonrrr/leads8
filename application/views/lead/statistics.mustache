{{>partials/header-tailwind}}

<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 py-8">
    <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        üìä Estat√≠sticas de Leads e Produtos
                    </h1>
                    <p class="text-gray-600">An√°lise detalhada da view vw_leads_produtos</p>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="realtime-clock" class="flex items-center text-2xl font-bold text-gray-800 bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-2 rounded-lg border border-blue-200 shadow-sm hover:shadow-md transition-all duration-300">
                        <span class="mr-2 animate-pulse">üïê</span>
                        <span id="clock-time" class="font-mono">--:--:--</span>
                    </div>
                    <div id="refresh-indicator" class="flex items-center text-sm text-gray-600 bg-gray-100 px-3 py-2 rounded-lg">
                        <span class="animate-pulse mr-2">üîÑ</span>
                        <span id="refresh-countdown">60s</span>
                        <button id="toggle-refresh" onclick="toggleAutoRefresh()" class="ml-2 text-blue-600 hover:text-blue-800" title="Pausar/Retomar Auto-refresh">
                            ‚è∏Ô∏è
                        </button>
                    </div>
                    <button onclick="exportarCSV()" class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Exportar CSV
                    </button>
                    <button onclick="carregarAPI()" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                        </svg>
                        Ver JSON
                    </button>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">üîç Filtros</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio</label>
                    <input type="date" id="dataInicio" value="{{filtros.data_inicio}}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                    <input type="date" id="dataFim" value="{{filtros.data_fim}}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Segmento</label>
                    <select id="segmento" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <option value="">Todos os Segmentos</option>
                        <option value="1" {{#filtros.segmento_1}}selected{{/filtros.segmento_1}}>üè≠ M√°quinas</option>
                        <option value="2" {{#filtros.segmento_2}}selected{{/filtros.segmento_2}}>‚öôÔ∏è Rolamentos</option>
                        <option value="3" {{#filtros.segmento_3}}selected{{/filtros.segmento_3}}>üîß Pe√ßas</option>
                        <option value="4" {{#filtros.segmento_4}}selected{{/filtros.segmento_4}}>üèóÔ∏è Metais</option>
                        <option value="5" {{#filtros.segmento_5}}selected{{/filtros.segmento_5}}>üöó Autope√ßas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <option value="">Todos os Status</option>
                        <option value="1" {{#filtros.status_1}}selected{{/filtros.status_1}}>‚úÖ Autorizado</option>
                        <option value="0" {{#filtros.status_0}}selected{{/filtros.status_0}}>‚è≥ Pendente</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Limite</label>
                    <select id="limite" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <option value="10">10 registros</option>
                        <option value="25">25 registros</option>
                        <option value="50" selected>50 registros</option>
                        <option value="100">100 registros</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="filtrarEstatisticas()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        Filtrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Estat√≠sticas Principais -->
        <div class="flex flex-wrap gap-4 mb-8">
            <!-- Total de Leads -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-md p-3 text-white flex items-center min-w-0 flex-1">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center">
                        <div class="bg-blue-400 bg-opacity-30 p-1.5 rounded-full mr-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-blue-100 text-xs font-medium">Total de Leads</p>
                            <p class="text-lg font-bold">{{stats.total_leads}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total de Produtos -->
            <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-md p-3 text-white flex items-center min-w-0 flex-1">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center">
                        <div class="bg-green-400 bg-opacity-30 p-1.5 rounded-full mr-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-blue-100 text-xs font-medium">Total de Produtos</p>
                            <p class="text-lg font-bold">{{stats.total_produtos}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total de Clientes -->
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg shadow-md p-3 text-white flex items-center min-w-0 flex-1">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center">
                        <div class="bg-purple-400 bg-opacity-30 p-1.5 rounded-full mr-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-purple-100 text-xs font-medium">Total de Clientes</p>
                            <p class="text-lg font-bold">{{stats.total_clientes}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Valor Total -->
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg shadow-md p-3 text-white flex items-center min-w-0 flex-1">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center">
                        <div class="bg-orange-400 bg-opacity-30 p-1.5 rounded-full mr-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-orange-100 text-xs font-medium">Valor Total</p>
                            <p class="text-lg font-bold">R$ {{stats.total_valor_formatado}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Autorizados -->
            <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-lg shadow-md p-3 text-white flex items-center min-w-0 flex-1">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center">
                        <div class="bg-emerald-400 bg-opacity-30 p-1.5 rounded-full mr-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-emerald-100 text-xs font-medium">Autorizados</p>
                            <p class="text-lg font-bold">{{stats.leads_autorizados}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pendentes -->
            <div class="bg-gradient-to-r from-amber-500 to-amber-600 rounded-lg shadow-md p-3 text-white flex items-center min-w-0 flex-1">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center">
                        <div class="bg-amber-400 bg-opacity-30 p-1.5 rounded-full mr-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-amber-100 text-xs font-medium">Pendentes</p>
                            <p class="text-lg font-bold">{{stats.leads_pendentes}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quantidade Total -->
            <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-lg shadow-md p-3 text-white flex items-center min-w-0 flex-1">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center">
                        <div class="bg-indigo-400 bg-opacity-30 p-1.5 rounded-full mr-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-indigo-100 text-xs font-medium">Qtd Total</p>
                            <p class="text-lg font-bold">{{stats.total_quantidade}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Valor M√©dio -->
            <div class="bg-gradient-to-r from-pink-500 to-pink-600 rounded-lg shadow-md p-3 text-white flex items-center min-w-0 flex-1">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center">
                        <div class="bg-pink-400 bg-opacity-30 p-1.5 rounded-full mr-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-pink-100 text-xs font-medium">Valor M√©dio</p>
                            <p class="text-lg font-bold">R$ {{stats.valor_medio_formatado}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>






        <!-- Totais por Lead COM Pedido POID -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mt-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">üìä Totais por Lead - COM Pedido POID</h3>
                        <p class="text-sm text-gray-600 mt-1">Leads que possuem um Pedido POID associado.</p>
                    </div>
                    <div id="lead-filter-controls" class="flex items-center space-x-2" style="display: none;">
                        <span class="text-xs text-gray-500">Filtros ativos:</span>
                        <button onclick="clearAllLeadFilters()" 
                                class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                            üóëÔ∏è Limpar Filtros
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-fixed w-full"
                       style="min-width: 1700px;">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-14"># N¬∫</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('data_emissao')" class="hover:text-blue-600 cursor-pointer">
                                    üìÖ Data Emiss√£o <span id="lead-sort-data_emissao" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                <a href="javascript:void(0)" onclick="sortLeadTable('hora_emissao')" class="hover:text-blue-600 cursor-pointer">
                                    üïê Hora <span id="lead-sort-hora_emissao" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                <a href="javascript:void(0)" onclick="sortLeadTable('lead_id')" class="hover:text-blue-600 cursor-pointer">
                                    üÜî Lead ID <span id="lead-sort-lead_id" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-28">
                                <a href="javascript:void(0)" onclick="sortLeadTable('pedido_poid')" class="hover:text-blue-600 cursor-pointer">
                                    üìã Pedido POID <span id="lead-sort-pedido_poid" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">
                                <a href="javascript:void(0)" onclick="sortLeadTable('cliente_nome')" class="hover:text-blue-600 cursor-pointer">
                                    üë§ Cliente <span id="lead-sort-cliente_nome" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('cliente_cidade')" class="hover:text-blue-600 cursor-pointer">
                                    üèôÔ∏è Cidade <span id="lead-sort-cliente_cidade" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                <a href="javascript:void(0)" onclick="sortLeadTable('cliente_estado')" class="hover:text-blue-600 cursor-pointer">
                                    üó∫Ô∏è Estado <span id="lead-sort-cliente_estado" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('usuario_apelido')" class="hover:text-blue-600 cursor-pointer">
                                    üë®‚Äçüíº Usu√°rio <span id="lead-sort-usuario_apelido" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>

                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                <a href="javascript:void(0)" onclick="sortLeadTable('total_produtos')" class="hover:text-blue-600 cursor-pointer">
                                    üì¶ Qtd Produtos <span id="lead-sort-total_produtos" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('total_quantidade')" class="hover:text-blue-600 cursor-pointer">
                                    üî¢ Qtd Total <span id="lead-sort-total_quantidade" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('valor_total_lead')" class="hover:text-blue-600 cursor-pointer">
                                    üí∞ Valor Total <span id="lead-sort-valor_total_lead" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('valor_medio_lead')" class="hover:text-blue-600 cursor-pointer">
                                    üíµ Valor M√©dio <span id="lead-sort-valor_medio_lead" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                <a href="javascript:void(0)" onclick="sortLeadTable('status')" class="hover:text-blue-600 cursor-pointer">
                                    ‚úÖ Status <span id="lead-sort-status" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {{#totaisPorLead}}
                        {{#pedido_poid}}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900 lead-row-number">{{@index}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-blue-600">{{data_emissao}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-orange-600">{{hora_emissao}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                                <a href="/leads8/lead/index/{{lead_id}}/1" 
                                   target="_blank"
                                   class="text-blue-600 hover:text-blue-800 font-medium">
                                    üÜî {{lead_id}}
                                </a>
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                                <a href="/leads8/lead/index/{{lead_id}}/1" 
                                   target="_blank"
                                   class="text-blue-600 hover:text-blue-800 font-medium">
                                    üìã {{pedido_poid}}
                                </a>
                            </td>
                            <td class="px-3 py-4 text-sm text-gray-900">
                                <a href="/leads8/customer/show/{{cliente_poid}}" 
                                   target="_blank"
                                   style="color: #FFA500;" 
                                   class="font-medium"
                                   title="{{cliente_nome}}">
                                    üë§ {{cliente_nome}}
                                </a>
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">{{cliente_cidade}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">{{cliente_estado}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">
                                <a href="/leads8/user/show/{{usuario_poid}}" 
                                   target="_blank"
                                   class="text-blue-600 hover:text-blue-800 font-medium">
                                    üë®‚Äçüíº {{usuario_apelido}}
                                </a>
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-center font-medium">{{total_produtos}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-right">{{total_quantidade_formatado}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-green-600">R$ {{valor_total_lead_formatado}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-purple-600">R$ {{valor_medio_lead_formatado}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center">
                                {{#status}}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        ‚úÖ Autorizado
                                    </span>
                                {{/status}}
                                {{^status}}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        ‚è≥ Pendente
                                    </span>
                                {{/status}}
                            </td>
                        </tr>
                        {{/pedido_poid}}
                        {{/totaisPorLead}}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Totais por Lead SEM Pedido POID -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mt-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">üìä Totais por Lead - SEM Pedido POID</h3>
                        <p class="text-sm text-gray-600 mt-1">Leads que N√ÉO possuem um Pedido POID associado.</p>
                    </div>
                    <div id="lead-filter-controls-no-poid" class="flex items-center space-x-2" style="display: none;">
                        <span class="text-xs text-gray-500">Filtros ativos:</span>
                        <button onclick="clearAllLeadFilters()" 
                                class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                            üóëÔ∏è Limpar Filtros
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-fixed w-full"
                       style="min-width: 1700px;">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-14"># N¬∫</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('data_emissao')" class="hover:text-blue-600 cursor-pointer">
                                    üìÖ Data Emiss√£o <span id="lead-sort-data_emissao" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                <a href="javascript:void(0)" onclick="sortLeadTable('hora_emissao')" class="hover:text-blue-600 cursor-pointer">
                                    üïê Hora <span id="lead-sort-hora_emissao" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                <a href="javascript:void(0)" onclick="sortLeadTable('lead_id')" class="hover:text-blue-600 cursor-pointer">
                                    üÜî Lead ID <span id="lead-sort-lead_id" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-28">
                                <a href="javascript:void(0)" onclick="sortLeadTable('pedido_poid')" class="hover:text-blue-600 cursor-pointer">
                                    üìã Pedido POID <span id="lead-sort-pedido_poid" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">
                                <a href="javascript:void(0)" onclick="sortLeadTable('cliente_nome')" class="hover:text-blue-600 cursor-pointer">
                                    üë§ Cliente <span id="lead-sort-cliente_nome" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('cliente_cidade')" class="hover:text-blue-600 cursor-pointer">
                                    üèôÔ∏è Cidade <span id="lead-sort-cliente_cidade" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                <a href="javascript:void(0)" onclick="sortLeadTable('cliente_estado')" class="hover:text-blue-600 cursor-pointer">
                                    üó∫Ô∏è Estado <span id="lead-sort-cliente_estado" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('usuario_apelido')" class="hover:text-blue-600 cursor-pointer">
                                    üë®‚Äçüíº Usu√°rio <span id="lead-sort-usuario_apelido" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>

                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                <a href="javascript:void(0)" onclick="sortLeadTable('total_produtos')" class="hover:text-blue-600 cursor-pointer">
                                    üì¶ Qtd Produtos <span id="lead-sort-total_produtos" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('total_quantidade')" class="hover:text-blue-600 cursor-pointer">
                                    üî¢ Qtd Total <span id="lead-sort-total_quantidade" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('valor_total_lead')" class="hover:text-blue-600 cursor-pointer">
                                    üí∞ Valor Total <span id="lead-sort-valor_total_lead" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                <a href="javascript:void(0)" onclick="sortLeadTable('valor_medio_lead')" class="hover:text-blue-600 cursor-pointer">
                                    üíµ Valor M√©dio <span id="lead-sort-valor_medio_lead" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">
                                <a href="javascript:void(0)" onclick="sortLeadTable('status')" class="hover:text-blue-600 cursor-pointer">
                                    ‚úÖ Status <span id="lead-sort-status" class="sort-icon">‚áÖ</span>
                                </a>
                            </th>
                        </tr>
                        <!-- Linha de filtros -->
                        <tr class="bg-gray-100 border-b border-gray-300">
                            <th class="px-3 py-2 w-14"></th>
                            <th class="px-3 py-2 w-32"></th>
                            <th class="px-3 py-2 w-24"></th>
                            <th class="px-3 py-2 w-24">
                                <input type="text" 
                                       id="lead-filter-lead-id" 
                                       value="{{filtros.lead_filter_lead_id}}"
                                       placeholder="Filtrar..."
                                       class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-blue-500 filter-input"
                                       onkeyup="debounceLeadFilter('lead_id', this.value)">
                            </th>
                            <th class="px-3 py-2 w-28">
                                <input type="text" 
                                       id="lead-filter-pedido-poid" 
                                       value="{{filtros.lead_filter_pedido_poid}}"
                                       placeholder="Filtrar..."
                                       class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-blue-500 filter-input"
                                       onkeyup="debounceLeadFilter('pedido_poid', this.value)">
                            </th>
                            <th class="px-3 py-2 w-48">
                                <input type="text" 
                                       id="lead-filter-cliente-nome" 
                                       value="{{filtros.lead_filter_cliente_nome}}"
                                       placeholder="Filtrar cliente..."
                                       class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-blue-500 filter-input"
                                       onkeyup="debounceLeadFilter('cliente_nome', this.value)">
                            </th>
                            <th class="px-3 py-2 w-32">
                                <input type="text" 
                                       id="lead-filter-cliente-cidade" 
                                       value="{{filtros.lead_filter_cliente_cidade}}"
                                       placeholder="Filtrar cidade..."
                                       class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-blue-500 filter-input"
                                       onkeyup="debounceLeadFilter('cliente_cidade', this.value)">
                            </th>
                            <th class="px-3 py-2 w-24">
                                <input type="text" 
                                       id="lead-filter-cliente-estado" 
                                       value="{{filtros.lead_filter_cliente_estado}}"
                                       placeholder="Filtrar estado..."
                                       class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-blue-500 filter-input"
                                       onkeyup="debounceLeadFilter('cliente_estado', this.value)">
                            </th>
                            <th class="px-3 py-2 w-32">
                                <input type="text" 
                                       id="lead-filter-usuario-apelido" 
                                       value="{{filtros.lead_filter_usuario_apelido}}"
                                       placeholder="Filtrar usu√°rio..."
                                       class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-blue-500 filter-input"
                                       onkeyup="debounceLeadFilter('usuario_apelido', this.value)">
                            </th>

                            <th class="px-3 py-2 w-24"></th>
                            <th class="px-3 py-2 w-32"></th>
                            <th class="px-3 py-2 w-32"></th>
                            <th class="px-3 py-2 w-32"></th>
                            <th class="px-3 py-2 w-24"></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {{#totaisPorLead}}
                        {{^pedido_poid}}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900 lead-row-number">{{@index}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-blue-600">{{data_emissao}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-orange-600">{{hora_emissao}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                                <a href="/leads8/lead/index/{{lead_id}}/1" 
                                   target="_blank"
                                   class="text-blue-600 hover:text-blue-800 font-medium">
                                    üÜî {{lead_id}}
                                </a>
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                                <a href="/leads8/lead/index/{{lead_id}}/1" 
                                   target="_blank"
                                   class="text-blue-600 hover:text-blue-800 font-medium">
                                    üìã {{pedido_poid}}
                                </a>
                            </td>
                            <td class="px-3 py-4 text-sm text-gray-900">
                                <a href="/leads8/customer/show/{{cliente_poid}}" 
                                   target="_blank"
                                   style="color: #FFA500;" 
                                   class="font-medium"
                                   title="{{cliente_nome}}">
                                    üë§ {{cliente_nome}}
                                </a>
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">{{cliente_cidade}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">{{cliente_estado}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">
                                <a href="/leads8/user/show/{{usuario_poid}}" 
                                   target="_blank"
                                   class="text-blue-600 hover:text-blue-800 font-medium">
                                    üë®‚Äçüíº {{usuario_apelido}}
                                </a>
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-center font-medium">{{total_produtos}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-right">{{total_quantidade_formatado}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-green-600">R$ {{valor_total_lead_formatado}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-purple-600">R$ {{valor_medio_lead_formatado}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center">
                                {{#status}}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        ‚úÖ Autorizado
                                    </span>
                                {{/status}}
                                {{^status}}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        ‚è≥ Pendente
                                    </span>
                                {{/status}}
                            </td>
                        </tr>
                        {{/pedido_poid}}
                        {{/totaisPorLead}}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginador para Totais por Lead -->
            {{#totaisPorLeadPagination}}
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Mostrando {{current_page}} de {{total_pages}} p√°ginas
                        ({{total}} registros no total)
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="changePage('leads', {{current_page}} - 1)" 
                                class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                {{^has_previous}}disabled{{/has_previous}}>
                            ‚Üê Anterior
                        </button>
                        
                        <button onclick="changePage('leads', {{current_page}})" 
                                class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                {{^has_next}}disabled{{/has_next}}>
                            Pr√≥ximo ‚Üí
                        </button>
                    </div>
                </div>
            </div>
            {{/totaisPorLeadPagination}}
        </div>
        
        <!-- Card de Acesso ao Top Produtos -->
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="bg-purple-400 bg-opacity-30 p-3 rounded-full mr-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white mb-2">üèÜ Top Produtos por Valor Total</h3>
                            <p class="text-purple-100">An√°lise detalhada dos produtos com maiores valores</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <button onclick="abrirTopProdutos()" 
                                class="inline-flex items-center px-6 py-3 bg-white text-purple-600 font-semibold rounded-lg hover:bg-purple-50 transition-all duration-200 transform hover:scale-105 shadow-lg">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                            Abrir Top Produtos
                        </button>
                    </div>
                </div>
                
                <!-- Estat√≠sticas resumidas -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div class="bg-purple-400 bg-opacity-20 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-white">{{stats.total_produtos}}</div>
                            <div class="ml-2 text-purple-100 text-sm">produtos √∫nicos</div>
                        </div>
                    </div>
                    <div class="bg-purple-400 bg-opacity-20 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-white">R$ {{stats.total_valor_formatado}}</div>
                            <div class="ml-2 text-purple-100 text-sm">valor total</div>
                        </div>
                    </div>
                    <div class="bg-purple-400 bg-opacity-20 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-white">{{stats.total_quantidade}}</div>
                            <div class="ml-2 text-purple-100 text-sm">quantidade total</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Card de Acesso ao Top Vendedores -->
        <div class="bg-gradient-to-r from-teal-500 to-teal-600 rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="bg-teal-400 bg-opacity-30 p-3 rounded-full mr-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white mb-2">üèÜ Top Vendedores por Performance</h3>
                            <p class="text-teal-100">Ranking dos vendedores por valor de vendas e taxa de aprova√ß√£o</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <button onclick="abrirTopVendedores()" 
                                class="inline-flex items-center px-6 py-3 bg-white text-teal-600 font-semibold rounded-lg hover:bg-teal-50 transition-all duration-200 transform hover:scale-105 shadow-lg">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                            Abrir Top Vendedores
                        </button>
                    </div>
                </div>
                
                <!-- Estat√≠sticas resumidas dos vendedores -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div class="bg-teal-400 bg-opacity-20 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-white">{{stats.total_clientes}}</div>
                            <div class="ml-2 text-teal-100 text-sm">clientes √∫nicos</div>
                        </div>
                    </div>
                    <div class="bg-teal-400 bg-opacity-20 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-white">{{stats.leads_autorizados}}</div>
                            <div class="ml-2 text-teal-100 text-sm">leads autorizados</div>
                        </div>
                    </div>
                    <div class="bg-teal-400 bg-opacity-20 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-white">R$ {{stats.valor_medio_formatado}}</div>
                            <div class="ml-2 text-teal-100 text-sm">valor m√©dio</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Card de Acesso ao Top Leads -->
        <div class="bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="bg-cyan-400 bg-opacity-30 p-3 rounded-full mr-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white mb-2">üìä Top Leads por Per√≠odo</h3>
                            <p class="text-cyan-100">Visualiza√ß√£o cronol√≥gica dos leads com distin√ß√£o entre consultas e pedidos</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <button onclick="abrirTopLeads()" 
                                class="inline-flex items-center px-6 py-3 bg-white text-cyan-600 font-semibold rounded-lg hover:bg-cyan-50 transition-all duration-200 transform hover:scale-105 shadow-lg">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                            Abrir Top Leads
                        </button>
                    </div>
                </div>
                
                <!-- Estat√≠sticas resumidas dos leads -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div class="bg-cyan-400 bg-opacity-20 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-white">{{stats.total_leads}}</div>
                            <div class="ml-2 text-cyan-100 text-sm">leads totais</div>
                        </div>
                    </div>
                    <div class="bg-cyan-400 bg-opacity-20 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-white">{{stats.leads_autorizados}}</div>
                            <div class="ml-2 text-cyan-100 text-sm">autorizados</div>
                        </div>
                    </div>
                    <div class="bg-cyan-400 bg-opacity-20 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-white">{{stats.total_clientes}}</div>
                            <div class="ml-2 text-cyan-100 text-sm">clientes √∫nicos</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Modal para JSON -->
<div id="jsonModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">üìÑ Dados em JSON</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="bg-gray-100 rounded-lg p-4 max-h-96 overflow-y-auto">
                <pre id="jsonContent" class="text-sm text-gray-800"></pre>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalhes do Lead -->
<div id="leadDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">üìã Detalhes do Lead</h3>
                <button onclick="closeLeadDetailsModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6">
                <div id="leadDetailsContent" class="space-y-4">
                    <!-- Conte√∫do ser√° inserido via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function filtrarEstatisticas() {
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const segmento = document.getElementById('segmento').value;
    const status = document.getElementById('status').value;
    const limite = document.getElementById('limite').value;
    
    const params = new URLSearchParams({
        data_inicio: dataInicio,
        data_fim: dataFim,
        segmento: segmento,
        status: status,
        limit: limite
    });
    
    // Reset pagina√ß√£o ao filtrar
    params.delete('offset');
    params.delete('lead_offset');
    
    window.location.href = '/leads8/lead/statistics?' + params.toString();
}

function exportarCSV() {
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const segmento = document.getElementById('segmento').value;
    const status = document.getElementById('status').value;
    
    const params = new URLSearchParams({
        data_inicio: dataInicio,
        data_fim: dataFim,
        segmento: segmento,
        status: status
    });
    
    window.location.href = '/leads8/lead/statistics/export?' + params.toString();
}

function carregarAPI() {
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const segmento = document.getElementById('segmento').value;
    const status = document.getElementById('status').value;
    
    const params = new URLSearchParams({
        data_inicio: dataInicio,
        data_fim: dataFim,
        segmento: segmento,
        status: status
    });
    
    fetch('/leads8/lead/statistics/api?' + params.toString())
        .then(response => response.json())
        .then(data => {
            document.getElementById('jsonContent').textContent = JSON.stringify(data, null, 2);
            document.getElementById('jsonModal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar dados da API');
        });
}

function closeModal() {
    document.getElementById('jsonModal').classList.add('hidden');
}

// Formatar n√∫meros
function formatNumber(num) {
    return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(num);
}

// Formatar moeda brasileira
function formatCurrency(num) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(num);
}

// Fechar modal ao clicar fora
document.getElementById('jsonModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Fechar modal de detalhes do lead ao clicar fora
document.getElementById('leadDetailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeLeadDetailsModal();
    }
});

// Numerar linhas da tabela come√ßando em 1
document.addEventListener('DOMContentLoaded', function() {
    const rowNumbers = document.querySelectorAll('.row-number');
    rowNumbers.forEach((cell, index) => {
        cell.textContent = index + 1;
    });
    
    const leadRowNumbers = document.querySelectorAll('.lead-row-number');
    leadRowNumbers.forEach((cell, index) => {
        cell.textContent = index + 1;
    });
});

// Auto-refresh a cada 1 minuto (60 segundos)
let refreshInterval;
let countdownInterval;
let countdownSeconds = 60;

function startAutoRefresh() {
    // Iniciar contagem regressiva
    startCountdown();
    
    refreshInterval = setInterval(function() {
        console.log('üîÑ Auto-refresh: Recarregando p√°gina...');
        window.location.reload();
    }, 60000); // 60 segundos = 1 minuto
}

function startCountdown() {
    countdownSeconds = 60;
    updateCountdownDisplay();
    
    countdownInterval = setInterval(function() {
        countdownSeconds--;
        updateCountdownDisplay();
        
        if (countdownSeconds <= 0) {
            countdownSeconds = 60; // Reset para pr√≥ximo ciclo
        }
    }, 1000);
}

function updateCountdownDisplay() {
    const countdownElement = document.getElementById('refresh-countdown');
    if (countdownElement) {
        countdownElement.textContent = countdownSeconds + 's';
        
        // Mudar cor baseado no tempo restante
        if (countdownSeconds <= 10) {
            countdownElement.className = 'text-red-600 font-bold';
        } else if (countdownSeconds <= 30) {
            countdownElement.className = 'text-orange-600 font-medium';
        } else {
            countdownElement.className = 'text-gray-600';
        }
    }
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        console.log('‚èπÔ∏è Auto-refresh: Parado');
    }
    if (countdownInterval) {
        clearInterval(countdownInterval);
        console.log('‚èπÔ∏è Contagem regressiva: Parada');
    }
}

let isAutoRefreshActive = true;
let clockInterval;

function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pt-BR', {
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    const clockElement = document.getElementById('clock-time');
    if (clockElement) {
        // Efeito de destaque quando os segundos mudam
        clockElement.style.transform = 'scale(1.05)';
        clockElement.style.color = '#1f2937';
        
        setTimeout(() => {
            clockElement.style.transform = 'scale(1)';
            clockElement.style.color = '#1f2937';
        }, 200);
        
        clockElement.textContent = timeString;
    }
}

function startClock() {
    updateClock(); // Atualizar imediatamente
    clockInterval = setInterval(updateClock, 1000); // Atualizar a cada segundo
}

function stopClock() {
    if (clockInterval) {
        clearInterval(clockInterval);
    }
}

function toggleAutoRefresh() {
    const toggleButton = document.getElementById('toggle-refresh');
    
    if (isAutoRefreshActive) {
        stopAutoRefresh();
        toggleButton.textContent = '‚ñ∂Ô∏è';
        toggleButton.title = 'Retomar Auto-refresh';
        document.getElementById('refresh-countdown').textContent = 'Pausado';
        console.log('‚è∏Ô∏è Auto-refresh pausado pelo usu√°rio');
    } else {
        startAutoRefresh();
        toggleButton.textContent = '‚è∏Ô∏è';
        toggleButton.title = 'Pausar Auto-refresh';
        console.log('‚ñ∂Ô∏è Auto-refresh retomado pelo usu√°rio');
    }
    
    isAutoRefreshActive = !isAutoRefreshActive;
}

// Iniciar auto-refresh e rel√≥gio quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
    startClock();
    console.log('üîÑ Auto-refresh iniciado: 1 minuto');
    console.log('üïê Rel√≥gio em tempo real iniciado');
});

// Parar auto-refresh e rel√≥gio quando a p√°gina perder foco (opcional)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
        stopClock();
        console.log('‚è∏Ô∏è Auto-refresh e rel√≥gio pausados: P√°gina n√£o vis√≠vel');
    } else {
        startAutoRefresh();
        startClock();
        console.log('‚ñ∂Ô∏è Auto-refresh e rel√≥gio retomados: P√°gina vis√≠vel');
    }
});

// JavaScript para ordena√ß√£o da tabela
function sortTable(column) {
    const urlParams = new URLSearchParams(window.location.search);
    const currentOrderBy = urlParams.get('order_by') || 'valor_total_item';
    const currentOrderDir = urlParams.get('order_dir') || 'DESC';
    
    let newOrderDir = 'DESC';
    
    // Se clicou na mesma coluna, inverte a dire√ß√£o
    if (currentOrderBy === column) {
        newOrderDir = (currentOrderDir === 'DESC') ? 'ASC' : 'DESC';
    }
    
    // Atualizar URL com novos par√¢metros de ordena√ß√£o
    urlParams.set('order_by', column);
    urlParams.set('order_dir', newOrderDir);
    
    window.location.search = urlParams.toString();
}

function updateSortIcons() {
    const urlParams = new URLSearchParams(window.location.search);
    const currentOrderBy = urlParams.get('order_by') || 'valor_total_item';
    const currentOrderDir = urlParams.get('order_dir') || 'DESC';
    
    // Reset all icons
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.textContent = '‚áÖ';
        icon.style.color = '#9CA3AF';
    });
    
    // Set active icon
    const activeIcon = document.getElementById('sort-' + currentOrderBy);
    if (activeIcon) {
        if (currentOrderDir === 'DESC') {
            activeIcon.textContent = '‚Üì';
            activeIcon.style.color = '#3B82F6';
        } else {
            activeIcon.textContent = '‚Üë';
            activeIcon.style.color = '#3B82F6';
        }
    }
}

// Atualizar √≠cones quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    updateSortIcons();
    updateLeadFilterControls();
    updateLeadSortIcons();
});


// Sistema de filtros com debounce
let filterTimeout = null;

function debounceFilter(column, value) {
    // Limpar timeout anterior
    if (filterTimeout) {
        clearTimeout(filterTimeout);
    }
    
    // Aguardar 800ms ap√≥s √∫ltima digita√ß√£o
    filterTimeout = setTimeout(function() {
        applyFilter(column, value);
    }, 800);
}

function applyFilter(column, value) {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Atualizar ou remover filtro
    if (value && value.trim() !== '') {
        urlParams.set('filter_' + column, value.trim());
    } else {
        urlParams.delete('filter_' + column);
    }
    
    // Reset p√°gina para primeira p√°gina quando filtrar
    urlParams.delete('offset');
    urlParams.delete('lead_offset');
    
    // Aplicar filtros
    window.location.search = urlParams.toString();
}

function clearAllFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Remover todos os filtros
    urlParams.delete('filter_cliente_nome');
    urlParams.delete('filter_cliente_cidade');
    urlParams.delete('filter_cliente_estado');
    urlParams.delete('filter_usuario_apelido');
    urlParams.delete('filter_produto_modelo');
    urlParams.delete('filter_produto_poid');
    urlParams.delete('filter_pedido_poid');
    
    // Reset pagina√ß√£o
    urlParams.delete('offset');
    urlParams.delete('lead_offset');
    
    window.location.search = urlParams.toString();
}

function hasActiveFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('filter_cliente_nome') ||
           urlParams.get('filter_cliente_cidade') ||
           urlParams.get('filter_cliente_estado') ||
           urlParams.get('filter_usuario_apelido') ||
           urlParams.get('filter_produto_modelo') ||
           urlParams.get('filter_produto_poid') ||
           urlParams.get('filter_pedido_poid');
}

// Fun√ß√µes para a tabela de totais por lead
function sortLeadTable(column) {
    const urlParams = new URLSearchParams(window.location.search);
    const currentOrderBy = urlParams.get('lead_order_by') || 'valor_total_lead';
    const currentOrderDir = urlParams.get('lead_order_dir') || 'DESC';
    
    let newOrderDir = 'DESC';
    
    // Se clicou na mesma coluna, inverte a dire√ß√£o
    if (currentOrderBy === column) {
        newOrderDir = (currentOrderDir === 'DESC') ? 'ASC' : 'DESC';
    }
    
    // Atualizar URL com novos par√¢metros de ordena√ß√£o
    urlParams.set('lead_order_by', column);
    urlParams.set('lead_order_dir', newOrderDir);
    
    window.location.search = urlParams.toString();
}

function updateLeadSortIcons() {
    const urlParams = new URLSearchParams(window.location.search);
    const currentOrderBy = urlParams.get('lead_order_by') || 'valor_total_lead';
    const currentOrderDir = urlParams.get('lead_order_dir') || 'DESC';
    
    // Reset all lead icons
    document.querySelectorAll('[id^="lead-sort-"]').forEach(icon => {
        icon.textContent = '‚áÖ';
        icon.style.color = '#9CA3AF';
    });
    
    // Set active lead icon
    const activeIcon = document.getElementById('lead-sort-' + currentOrderBy);
    if (activeIcon) {
        if (currentOrderDir === 'DESC') {
            activeIcon.textContent = '‚Üì';
            activeIcon.style.color = '#3B82F6';
        } else {
            activeIcon.textContent = '‚Üë';
            activeIcon.style.color = '#3B82F6';
        }
    }
}

// Sistema de filtros para leads com debounce
let leadFilterTimeout = null;

function debounceLeadFilter(column, value) {
    // Limpar timeout anterior
    if (leadFilterTimeout) {
        clearTimeout(leadFilterTimeout);
    }
    
    // Aguardar 800ms ap√≥s √∫ltima digita√ß√£o
    leadFilterTimeout = setTimeout(function() {
        applyLeadFilter(column, value);
    }, 800);
}

function applyLeadFilter(column, value) {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Atualizar ou remover filtro
    if (value && value.trim() !== '') {
        urlParams.set('lead_filter_' + column, value.trim());
    } else {
        urlParams.delete('lead_filter_' + column);
    }
    
    // Reset p√°gina para primeira p√°gina quando filtrar
    urlParams.delete('lead_offset');
    urlParams.delete('offset');
    
    // Aplicar filtros
    window.location.search = urlParams.toString();
}

function clearAllLeadFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Remover todos os filtros de lead
    urlParams.delete('lead_filter_cliente_nome');
    urlParams.delete('lead_filter_cliente_cidade');
    urlParams.delete('lead_filter_cliente_estado');
    urlParams.delete('lead_filter_usuario_apelido');
    urlParams.delete('lead_filter_pedido_poid');
    urlParams.delete('lead_filter_lead_id');
    
    // Reset pagina√ß√£o
    urlParams.delete('offset');
    urlParams.delete('lead_offset');
    
    window.location.search = urlParams.toString();
}

function hasActiveLeadFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('lead_filter_cliente_nome') ||
           urlParams.get('lead_filter_cliente_cidade') ||
           urlParams.get('lead_filter_cliente_estado') ||
           urlParams.get('lead_filter_usuario_apelido') ||
           urlParams.get('lead_filter_pedido_poid') ||
           urlParams.get('lead_filter_lead_id');
}

// Fun√ß√£o para navegar entre p√°ginas
function changePage(tableType, page) {
    const urlParams = new URLSearchParams(window.location.search);
    const limit = urlParams.get('limit') || 50;
    
    if (tableType === 'produtos') {
        urlParams.set('offset', (page * limit).toString());
        urlParams.delete('lead_offset'); // Reset pagina√ß√£o de leads
    } else if (tableType === 'leads') {
        urlParams.set('lead_offset', (page * limit).toString());
        urlParams.delete('offset'); // Reset pagina√ß√£o de produtos
    }
    
    window.location.search = urlParams.toString();
}

// Fun√ß√£o para mostrar detalhes do lead em um modal
function showLeadDetails(pedido_poid, cliente_nome, cliente_cidade, cliente_estado, usuario_apelido, data_emissao, hora_emissao, total_produtos, total_quantidade_formatado, valor_total_lead_formatado, valor_medio_lead_formatado, status) {
    const statusText = status === '1' ? '‚úÖ Autorizado' : '‚è≥ Pendente';
    const statusColor = status === '1' ? 'text-green-600' : 'text-yellow-600';
    
    const leadDetails = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Informa√ß√µes B√°sicas -->
            <div class="space-y-4">
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                    <h4 class="text-md font-semibold text-gray-800 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Informa√ß√µes B√°sicas
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">üìã Pedido POID:</span>
                            <span class="text-gray-900 font-semibold">${pedido_poid}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">üë§ Cliente:</span>
                            <span class="text-gray-900">${cliente_nome}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">üèôÔ∏è Cidade:</span>
                            <span class="text-gray-900">${cliente_cidade}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">üó∫Ô∏è Estado:</span>
                            <span class="text-gray-900">${cliente_estado}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">üë®‚Äçüíº Usu√°rio:</span>
                            <span class="text-gray-900">${usuario_apelido}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informa√ß√µes de Data e Valores -->
            <div class="space-y-4">
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                    <h4 class="text-md font-semibold text-gray-800 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Data e Hora
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">üìÖ Data:</span>
                            <span class="text-gray-900">${data_emissao}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">üïê Hora:</span>
                            <span class="text-gray-900">${hora_emissao}</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                    <h4 class="text-md font-semibold text-gray-800 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                        Valores e Quantidades
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">üì¶ Qtd Produtos:</span>
                            <span class="text-gray-900 font-semibold">${total_produtos}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">üî¢ Qtd Total:</span>
                            <span class="text-gray-900 font-semibold">${total_quantidade_formatado}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">üí∞ Valor Total:</span>
                            <span class="text-green-600 font-bold">R$ ${valor_total_lead_formatado}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 font-medium">üíµ Valor M√©dio:</span>
                            <span class="text-purple-600 font-bold">R$ ${valor_medio_lead_formatado}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status -->
        <div class="mt-6 bg-white rounded-lg p-4 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between">
                <span class="text-gray-600 font-medium">Status do Lead:</span>
                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor} bg-opacity-10 ${status === '1' ? 'bg-green-100' : 'bg-yellow-100'}">
                    ${statusText}
                </span>
            </div>
        </div>
    `;

    document.getElementById('leadDetailsContent').innerHTML = leadDetails;
    document.getElementById('leadDetailsModal').classList.remove('hidden');
}

// Fun√ß√£o para fechar o modal de detalhes do lead
function closeLeadDetailsModal() {
    document.getElementById('leadDetailsModal').classList.add('hidden');
}

// Fun√ß√£o para abrir detalhes do cliente em uma janela WinBox
function openClienteDetails(clientePoid, clienteNome) {
    // Usar URL completa para garantir que carregue
    const url = `https://dev.office.internut.com.br/K3/tip/vcustomer/${clientePoid}/`;
    
    console.log('üë§ Abrindo detalhes do Cliente:', clientePoid);
    console.log('üìç URL:', url);
    
    // Bloquear scroll da p√°gina pai imediatamente
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    
    // Criar janela WinBox com configura√ß√µes avan√ßadas
    const winbox = new WinBox({
        title: `üë§ Detalhes do Cliente: ${clienteNome}`,
        url: url,
        width: '90%',
        height: '85%',
        class: "iframe",    
        x: 'center',
        y: 'top',
        top: '5%',
        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        border: '3px',
        modal: true,
        minwidth: 1000,
        minheight: 700,
        maxwidth: '95%',
        maxheight: '90%',
        onclose: function() {
            console.log(`Janela do Cliente ${clienteNome} fechada`);
            // Reativar scroll da p√°gina pai
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
        },
        onload: function() {
            console.log(`‚úÖ Conte√∫do carregado para Cliente ${clienteNome}`);
        }
    });
    
    console.log(`üë§ Janela WinBox criada para Cliente ${clienteNome}`);
    console.log(`üìç URL: ${url}`);
}

// Fun√ß√£o para abrir detalhes do lead em uma janela WinBox
function openLeadDetails(leadId) {
    // Usar URL completa para garantir que carregue
    const url = `https://dev.office.internut.com.br/leads8/lead/index/${leadId}/1`;
    
    console.log('üÜî Abrindo detalhes do Lead:', leadId);
    console.log('üìç URL:', url);
    
    // Bloquear scroll da p√°gina pai imediatamente
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    
    // Criar janela WinBox com configura√ß√µes avan√ßadas
    const winbox = new WinBox({
        title: `üÜî Detalhes do Lead #${leadId}`,
        url: url,
        width: '90%',
        height: '85%',
        class: "iframe",    
        x: 'center',
        y: 'top',
        top: '5%',
        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        border: '3px',
        modal: true,
        minwidth: 1000,
        minheight: 700,
        maxwidth: '95%',
        maxheight: '90%',
        onclose: function() {
            console.log(`Janela do Lead #${leadId} fechada`);
            // Reativar scroll da p√°gina pai
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
        },
        onload: function() {
            console.log(`‚úÖ Conte√∫do carregado para Lead #${leadId}`);
        }
    });
    
    console.log(`üÜî Janela WinBox criada para Lead #${leadId}`);
    console.log(`üìç URL: ${url}`);
}

// Fun√ß√£o para abrir detalhes do pedido em uma janela WinBox
function openOrderDetails(pedidoPoid) {
    // Usar URL completa para garantir que carregue
    const url = `https://dev.office.internut.com.br/K3/tip/order/${pedidoPoid}/`;
    
    console.log('üìã Abrindo detalhes do Pedido:', pedidoPoid);
    console.log('üìç URL:', url);
    
    // Bloquear scroll da p√°gina pai imediatamente
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    
    // Criar janela WinBox com configura√ß√µes avan√ßadas
    const winbox = new WinBox({
        title: `üìã Detalhes do Pedido #${pedidoPoid}`,
        url: url,
        width: '90%',
        height: '85%',
        class: "iframe",    
        x: 'center',
        y: 'top',
        top: '5%',
        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        border: '3px',
        modal: true,
        minwidth: 1000,
        minheight: 700,
        maxwidth: '95%',
        maxheight: '90%',
        onclose: function() {
            console.log(`Janela do Pedido #${pedidoPoid} fechada`);
            // Reativar scroll da p√°gina pai
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
        },
        onload: function() {
            console.log(`‚úÖ Conte√∫do carregado para Pedido #${pedidoPoid}`);
        }
    });
    
    console.log(`üìã Janela WinBox criada para Pedido #${pedidoPoid}`);
    console.log(`üìç URL: ${url}`);
}

// Fun√ß√£o para abrir detalhes do usu√°rio/vendedor em uma janela WinBox
function openUsuarioDetails(vendedorPoid, produtoSegmentoId, usuarioApelido) {
    // Usar URL fornecida para CRM
    const url = `/crm/v506/Index/index/${vendedorPoid}/${produtoSegmentoId}/`;
    
    console.log('üë®‚Äçüíº Abrindo detalhes do Usu√°rio:', usuarioApelido);
    console.log('üìç URL:', url);
    console.log('üÜî Vendedor POID:', vendedorPoid);
    console.log('üè∑Ô∏è Produto Segmento ID:', produtoSegmentoId);
    
    // Bloquear scroll da p√°gina pai imediatamente
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    
    // Criar janela WinBox com configura√ß√µes avan√ßadas
    const winbox = new WinBox({
        title: `üë®‚Äçüíº CRM do Usu√°rio: ${usuarioApelido}`,
        url: url,
        width: '90%',
        height: '85%',
        class: "iframe",    
        x: 'center',
        y: 'top',
        top: '5%',
        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        border: '3px',
        modal: true,
        minwidth: 1000,
        minheight: 700,
        maxwidth: '95%',
        maxheight: '90%',
        onclose: function() {
            console.log(`Janela do Usu√°rio ${usuarioApelido} fechada`);
            // Reativar scroll da p√°gina pai
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
        },
        onload: function() {
            console.log(`‚úÖ Conte√∫do carregado para Usu√°rio ${usuarioApelido}`);
        }
    });
    
    console.log(`üë®‚Äçüíº Janela WinBox criada para Usu√°rio ${usuarioApelido}`);
    console.log(`üìç URL: ${url}`);
}

// Fun√ß√£o para abrir p√°gina Top Produtos
function abrirTopProdutos() {
    // Debug: verificar se a fun√ß√£o est√° sendo chamada
    console.log('üèÜ Fun√ß√£o abrirTopProdutos() chamada');
    
    // Capturar filtros atuais
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const segmento = document.getElementById('segmento').value;
    const status = document.getElementById('status').value;
    const limite = document.getElementById('limite').value;
    
    // Debug: verificar valores capturados
    console.log('üìã Filtros capturados:', {
        dataInicio, dataFim, segmento, status, limite
    });
    
    // Construir URL com filtros preservados
    const params = new URLSearchParams({
        data_inicio: dataInicio,
        data_fim: dataFim,
        segmento: segmento,
        status: status,
        limit: limite
    });
    
    // Construir URL final - tentar primeiro via rota direta
    const finalUrl = '/leads8/lead/statistics/top_produtos?' + params.toString();
    console.log('üîó URL final constru√≠da:', finalUrl);
    
    // Abrir Top Produtos em nova aba/janela
    console.log('üöÄ Abrindo Top Produtos em nova aba...');
    window.open(finalUrl, '_blank');
}

// Fun√ß√£o para abrir p√°gina Top Vendedores
function abrirTopVendedores() {
    // Debug: verificar se a fun√ß√£o est√° sendo chamada
    console.log('üèÜ Fun√ß√£o abrirTopVendedores() chamada');
    
    // Capturar filtros atuais
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const segmento = document.getElementById('segmento').value;
    const status = document.getElementById('status').value;
    const limite = document.getElementById('limite').value;
    
    // Debug: verificar valores capturados
    console.log('üìã Filtros capturados:', {
        dataInicio, dataFim, segmento, status, limite
    });
    
    // Construir URL com filtros preservados
    const params = new URLSearchParams({
        data_inicio: dataInicio,
        data_fim: dataFim,
        segmento: segmento,
        status: status,
        limit: limite
    });
    
    // Construir URL final - usar rota direta
    const finalUrl = '/leads8/lead/statistics/top_vendedores?' + params.toString();
    console.log('üîó URL final constru√≠da:', finalUrl);
    
    // Abrir Top Vendedores em nova aba/janela
    console.log('üöÄ Abrindo Top Vendedores em nova aba...');
    window.open(finalUrl, '_blank');
}

// Fun√ß√£o para abrir p√°gina Top Leads
function abrirTopLeads() {
    // Debug: verificar se a fun√ß√£o est√° sendo chamada
    console.log('üìä Fun√ß√£o abrirTopLeads() chamada');
    
    // Capturar filtros atuais
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    const segmento = document.getElementById('segmento').value;
    const status = document.getElementById('status').value;
    const limite = document.getElementById('limite').value;
    
    // Debug: verificar valores capturados
    console.log('üìã Filtros capturados:', {
        dataInicio, dataFim, segmento, status, limite
    });
    
    // Construir URL com filtros preservados
    const params = new URLSearchParams({
        data_inicio: dataInicio,
        data_fim: dataFim,
        segmento: segmento,
        status: status,
        limit: limite
    });
    
    // Construir URL final - usar rota direta
    const finalUrl = '/leads8/lead/statistics/top_leads?' + params.toString();
    console.log('üîó URL final constru√≠da:', finalUrl);
    
    // Abrir Top Leads em nova aba/janela
    console.log('üöÄ Abrindo Top Leads em nova aba...');
    window.open(finalUrl, '_blank');
}
</script>

<!-- WinBox.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/winbox@0.2.82/dist/winbox.bundle.min.js"></script>

<!-- CSS para indicadores de ordena√ß√£o -->
<style>
/* Estilos personalizados para WinBox */
.winbox {
    border-radius: 8px !important;
    overflow: hidden !important;
}

.wb-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    font-weight: 600 !important;
    cursor: move !important;
    user-select: none !important;
}

.wb-control {
    display: flex !important;
    align-items: center !important;
    gap: 2px !important;
}

.wb-control span {
    width: 20px !important;
    height: 20px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    cursor: pointer !important;
    border-radius: 3px !important;
    transition: background-color 0.2s !important;
}

.wb-control span:hover {
    background-color: rgba(255, 255, 255, 0.2) !important;
}

.wb-min {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M2 5h8v2H2z'/%3E%3C/svg%3E") !important;
    background-size: 12px !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
}

.wb-max {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M2 2h8v8H2z'/%3E%3C/svg%3E") !important;
    background-size: 12px !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
}

.wb-close {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M3 3l6 6m0-6l-6 6' stroke='white' stroke-width='1.5'/%3E%3C/svg%3E") !important;
    background-size: 12px !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
}

.wb-body {
    background: #f8fafc !important;
    border-radius: 0 0 8px 8px !important;
    overflow: auto !important;
    padding: 0 !important;
}

.wb-body iframe {
    width: 100% !important;
    height: 100% !important;
    border: none !important;
    background: white !important;
    overflow: auto !important;
    display: block !important;
}

/* Scrollbar personalizada */
.wb-body::-webkit-scrollbar {
    width: 8px !important;
}

.wb-body::-webkit-scrollbar-track {
    background: #f1f5f9 !important;
    border-radius: 4px !important;
}

.wb-body::-webkit-scrollbar-thumb {
    background: #cbd5e1 !important;
    border-radius: 4px !important;
}

.wb-body::-webkit-scrollbar-thumb:hover {
    background: #94a3b8 !important;
}

/* Estados da janela */
.winbox.max {
    border-radius: 0 !important;
}

.winbox.max .wb-body {
    border-radius: 0 !important;
}

.winbox.min {
    border-radius: 8px !important;
}

/* Scrollbar personalizada para o iframe */
.wb-body iframe {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
    overflow-y: auto !important;
    overflow-x: auto !important;
}

/* Garantir que o conte√∫do do iframe seja scroll√°vel */
.wb-body iframe::-webkit-scrollbar {
    width: 12px !important;
    height: 12px !important;
}

.wb-body iframe::-webkit-scrollbar-track {
    background: #f1f5f9 !important;
    border-radius: 6px !important;
}

.wb-body iframe::-webkit-scrollbar-thumb {
    background: #cbd5e1 !important;
    border-radius: 6px !important;
    border: 2px solid #f1f5f9 !important;
}

.wb-body iframe::-webkit-scrollbar-thumb:hover {
    background: #94a3b8 !important;
}

.wb-body iframe::-webkit-scrollbar-corner {
    background: #f1f5f9 !important;
}


.sort-icon {
    font-size: 12px;
    margin-left: 4px;
    color: #9CA3AF;
    transition: color 0.2s;
}

.cursor-pointer:hover .sort-icon {
    color: #3B82F6 !important;
}

th a {
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    width: 100%;
}

th a:hover {
    text-decoration: none;
}

/* Estilos para inputs de filtro */
.filter-input {
    transition: all 0.2s ease;
    background-color: #ffffff;
}

.filter-input:focus {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.15);
}

.filter-input:not(:placeholder-shown) {
    background-color: #eff6ff;
    border-color: #3b82f6;
    font-weight: 500;
}

/* Indicador visual para filtros ativos */
.bg-gray-100 {
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
}

/* Anima√ß√£o suave para controles de filtro */
#filter-controls {
    transition: all 0.3s ease;
}

.table-container {
    position: relative;
}

.filter-active-indicator {
    position: absolute;
    top: 0;
    right: 0;
    width: 8px;
    height: 8px;
    background-color: #3b82f6;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
